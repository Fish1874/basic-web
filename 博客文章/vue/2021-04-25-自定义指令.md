## 自定义指令 directive

> 因为vue是数据驱动，所以不推荐直接操作底层dom，但你仍有这方面的需求时，就需要用到自定义指令了。



### 注册指令 directive

```javascript
//---------- 全局注册
Vue.directive('focus', {
  // 钩子函数
});

//---------- 局部注册
directive: {
   focus: {
     // 钩子函数
   }
}

//---------- 模板使用指令
<template>
  <input v-focus>
<template>
```



### [钩子函数](https://cn.vuejs.org/v2/guide/custom-directive.html#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0)

> 自定义指令的对象，包含如下几个钩子函数：

- `bind` ：只调用一次，指令第一次绑定到元素时调用。
- `inserted ` ：被绑元素插入父节点时调用。
- `update` : 所在组件的虚拟dom更新时调用。

- `componentUpdated` : 指令所在组件的 VNode以其子 VNode全部更新后调用
- `unbind` : 只调用一次，指令与元素解绑时。



### 钩子函数的参数

- `el` : 指令所绑定的元素。
- `binding` : 一个对象，包含一下 property:
  - name：指令名
  - value：指令绑定的值
  - [......](https://cn.vuejs.org/v2/guide/custom-directive.html#%E9%92%A9%E5%AD%90%E5%87%BD%E6%95%B0%E5%8F%82%E6%95%B0)

- `vnode` : Vue编译生成的虚拟节点。
- `oldVnode` ：上一个虚拟节点（update 和 componentUpdated 才有）。



### 案例：控制按钮的权限

```javascript
const role = 'user';
Vue.directive('permission', {
  inserted(el) {
  	if (role !== 'admin') {
  	  el.parentElement.removeChild(el);
  	}
  }
});
```

使用：

```javascript
<div v-permission="'admin'">
```



### 案例二：一键copy功能

1. 首先建立一个js文件，定义一个对象。（指令的本质就是一个对象）

```javascript
const yyyCopy = { // 指令名字
  /*
    bind 钩子函数，第一次绑定时调用，可以在这里做初始化设置
    el: 作用的 dom 对象
    value: 传给指令的值，也就是我们要 copy 的值
  */
  bind(el, { value }) {
    el.$value = value; // 用一个全局属性来存传进来的值，因为这个值在别的钩子函数里还会用到
    el.handler = () => {
      if (!el.$value) {
      // 值为空的时候，给出提示，我这里的提示是用的 ant-design-vue 的提示，你们随意
        alert('无复制内容');
        return;
      }
      // 动态创建 textarea 标签
      const textarea = document.createElement('textarea');
      // 将该 textarea 设为 readonly 防止 iOS 下自动唤起键盘，同时将 textarea 移出可视区域
      textarea.readOnly = 'readonly';
      textarea.style.position = 'absolute';
      textarea.style.left = '-9999px';
      // 将要 copy 的值赋给 textarea 标签的 value 属性
      textarea.value = el.$value;
      // 将 textarea 插入到 body 中
      document.body.appendChild(textarea);
      // 选中值并复制
      textarea.select();
      // textarea.setSelectionRange(0, textarea.value.length);
      const result = document.execCommand('Copy');
      if (result) {
        alert('复制成功');
      }
      document.body.removeChild(textarea);
    };
    // 绑定点击事件，就是所谓的一键 copy 啦
    el.addEventListener('click', el.handler);
  },
  // 当传进来的值更新的时候触发
  componentUpdated(el, { value }) {
    el.$value = value;
  },
  // 指令与元素解绑的时候，移除事件绑定
  unbind(el) {
    el.removeEventListener('click', el.handler);
  },
};

export default yyyCopy;
```

2. 将自定义指令注册到全局： 新建一个 **directives.js** 来注册所有的全局指令。

```javascript
import copy from './y-copy';

// 自定义指令
const directivesList = {
    copy,
    ...
}

// 批量注册指令↓↓↓
export default {
  install(Vue) {
    Object.keys(directivesList).forEach((key) => {
      Vue.directive(key, directives[key]);
    });
  },
};
```

接着再 **main.js**引入：

```javascript
import Vue from 'vue';
import Directives from './directives';

Vue.use(Directives);
```

[参考文章](https://www.cnblogs.com/chenwenhao/p/11924161.html)





